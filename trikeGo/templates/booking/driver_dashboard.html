{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Dashboard - TrikeGo</title>
    <link rel="stylesheet" href="{% static 'user/css/driver_dashboard.css' %}" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>
<body>
    <div class="header">
        <h1>Driver Dashboard</h1>
        <a href="{% url 'user:landing' %}" class="logout-btn">Logout</a>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="dashboard-profile-card">
                <h2>Welcome, {{ user.first_name }} {{ user.last_name }}!</h2>
                <p>Driver ID: {{ user.username }}</p>
            </div>

            <div class="dashboard-quickaction-card">
                <h3>Quick Actions</h3>
                <div class="action-buttons">
                    <a href="{% url 'user:driver_active_books' %}" class="btn btn-primary">View My Rides</a>
                    <a href="#" class="btn btn-secondary">Update Profile</a>
                </div>
            </div>
            
            {% if driver_profile %}
            <div class="dashboard-profile-card">
                <h3>Profile</h3>
                <p><strong>Status:</strong> {{ driver_profile.status }}</p>
                <p><strong>Verified:</strong> {{ driver_profile.is_verified|yesno:"Yes,No" }}</p>
            </div>
            {% endif %}
        </div>

        <div class="main-content">
            <div class="dashboard-activity-card">
                <h3>Available Rides</h3>
                {% if available_rides %}
                    <ul class="ride-list">
                        {% for ride in available_rides %}
                            <li class="ride-item">
                                <strong>From:</strong> {{ ride.pickup_address }}<br>
                                <strong>To:</strong> {{ ride.destination_address }}<br>
                                <small>Requested: {{ ride.booking_time|date:"M d, Y H:i" }}</small>
                                <div class="ride-actions">
                                    <button class="btn btn-secondary review-ride-btn" data-booking-id="{{ ride.id }}">
                                        Review
                                    </button>
                                    <form method="POST" action="{% url 'user:accept_ride' ride.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success">Accept Ride</button>
                                    </form>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p>No rides available right now.</p>
                {% endif %}
            </div>
            
            <div class="dashboard-section">
                <h2>Ride Preview</h2>
                <div id="map-container"></div>
                <div id="route-details">Click 'Review' on a ride to see the route details here.</div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ORS_API_KEY = '{{ settings.OPENROUTESERVICE_API_KEY }}' || '5b3ce3597851110001cf62488c26abeb';

            const map = L.map('map-container').setView([10.3157, 123.8854], 13);
            
            // Use OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            let driverToRiderRouteLayer, riderToDestRouteLayer;
            let riderMarker, destMarker, driverMarker;
            const routeDetailsContainer = document.getElementById('route-details');
            const reviewButtons = document.querySelectorAll('.review-ride-btn');

            reviewButtons.forEach(button => {
                button.addEventListener('click', async function() {
                    const bookingId = this.dataset.bookingId;
                    routeDetailsContainer.innerHTML = "Fetching route information...";

                    try {
                        // Get all coordinates from backend
                        const infoResponse = await fetch(`/api/booking/${bookingId}/route_info/`);
                        const routeInfo = await infoResponse.json();

                        if (routeInfo.status !== 'success') {
                            throw new Error(routeInfo.message);
                        }
                        
                        // Clear previous layers
                        if (driverToRiderRouteLayer) map.removeLayer(driverToRiderRouteLayer);
                        if (riderToDestRouteLayer) map.removeLayer(riderToDestRouteLayer);
                        if (riderMarker) map.removeLayer(riderMarker);
                        if (destMarker) map.removeLayer(destMarker);
                        if (driverMarker) map.removeLayer(driverMarker);

                        // Add marker for driver location (current position)
                        const driverLatLng = [routeInfo.driver_lat, routeInfo.driver_lon];
                        const driverIcon = L.divIcon({
                            className: 'driver-marker',
                            html: '<div style="background: #007bff; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                            iconSize: [30, 30]
                        });
                        driverMarker = L.marker(driverLatLng, { icon: driverIcon }).addTo(map).bindPopup('Your Location');

                        // Add markers for pickup and destination
                        const pickupLatLng = [routeInfo.pickup_lat, routeInfo.pickup_lon];
                        const destLatLng = [routeInfo.destination_lat, routeInfo.destination_lon];
                        
                        const pickupIcon = L.divIcon({
                            className: 'pickup-marker',
                            html: '<div style="background: #ffc107; width: 25px; height: 25px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                            iconSize: [25, 25]
                        });
                        
                        const destIcon = L.divIcon({
                            className: 'dest-marker',
                            html: '<div style="background: #dc3545; width: 25px; height: 25px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>',
                            iconSize: [25, 25]
                        });
                        
                        riderMarker = L.marker(pickupLatLng, { icon: pickupIcon }).addTo(map).bindPopup('Pickup Location');
                        destMarker = L.marker(destLatLng, { icon: destIcon }).addTo(map).bindPopup('Destination');

                        // Fetch Driver-to-Rider route using ORS
                        const dtUrl = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${ORS_API_KEY}&start=${routeInfo.driver_lon},${routeInfo.driver_lat}&end=${routeInfo.pickup_lon},${routeInfo.pickup_lat}`;
                        const dtResponse = await fetch(dtUrl);
                        const dtResult = await dtResponse.json();
                        
                        if (dtResult.features && dtResult.features.length > 0) {
                            const dtRoute = dtResult.features[0];
                            driverToRiderRouteLayer = L.geoJSON(dtRoute, {
                                style: {
                                    color: '#007bff',
                                    weight: 5,
                                    opacity: 0.8
                                }
                            }).addTo(map);
                        }

                        // Fetch Rider-to-Destination route using ORS
                        const rdUrl = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${ORS_API_KEY}&start=${routeInfo.pickup_lon},${routeInfo.pickup_lat}&end=${routeInfo.destination_lon},${routeInfo.destination_lat}`;
                        const rdResponse = await fetch(rdUrl);
                        const rdResult = await rdResponse.json();
                        
                        if (rdResult.features && rdResult.features.length > 0) {
                            const rdRoute = rdResult.features[0];
                            riderToDestRouteLayer = L.geoJSON(rdRoute, {
                                style: {
                                    color: '#28a745',
                                    weight: 5,
                                    opacity: 0.8
                                }
                            }).addTo(map);
                        }
                        
                        // Fit map to show both routes
                        const allLayers = [];
                        if (driverToRiderRouteLayer) allLayers.push(driverToRiderRouteLayer);
                        if (riderToDestRouteLayer) allLayers.push(riderToDestRouteLayer);
                        
                        if (allLayers.length > 0) {
                            let bounds = allLayers[0].getBounds();
                            allLayers.forEach(layer => {
                                bounds.extend(layer.getBounds());
                            });
                            map.fitBounds(bounds, { padding: [50, 50] });
                        }

                        // Display combined details
                        const dtProps = dtResult.features[0].properties;
                        const rdProps = rdResult.features[0].properties;
                        
                        const dtDistance = (dtProps.segments[0].distance / 1000).toFixed(2);
                        const dtTime = (dtProps.segments[0].duration / 60).toFixed(0);
                        const rdDistance = (rdProps.segments[0].distance / 1000).toFixed(2);
                        const rdTime = (rdProps.segments[0].duration / 60).toFixed(0);
                        
                        const totalDistance = (parseFloat(dtDistance) + parseFloat(rdDistance)).toFixed(2);
                        const totalTime = (parseInt(dtTime) + parseInt(rdTime));

                        routeDetailsContainer.innerHTML = `
                            <div style="margin-bottom: 15px;">
                                <p><strong style="color: #007bff;">ðŸš— To Pickup Point:</strong></p>
                                <p style="margin-left: 20px;">Distance: ${dtDistance} km | Time: ${dtTime} mins</p>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <p><strong style="color: #28a745;">ðŸŽ¯ Trip to Destination:</strong></p>
                                <p style="margin-left: 20px;">Distance: ${rdDistance} km | Time: ${rdTime} mins</p>
                            </div>
                            <hr style="margin: 15px 0;">
                            <div>
                                <p><strong>ðŸ“Š Total Journey:</strong></p>
                                <p style="margin-left: 20px;">Distance: ${totalDistance} km | Time: ${totalTime} mins</p>
                            </div>
                        `;

                    } catch (error) {
                        console.error("ORS Routing error:", error);
                        routeDetailsContainer.innerHTML = `<p style="color: #dc3545;">Could not calculate the route. ${error.message}</p>`;
                    }
                });
            });
        });
    </script>

    <script>
    // Driver Location Broadcasting System
    let locationWatchId = null;
    let isTracking = false;
    let currentBookingId = null;

    document.addEventListener('DOMContentLoaded', function() {
        checkActiveBooking();
        addLocationToggle();
    });

    function checkActiveBooking() {
        const activeBookingElement = document.querySelector('[data-active-booking-id]');
        if (activeBookingElement) {
            currentBookingId = activeBookingElement.dataset.activeBookingId;
            startLocationTracking();
        }
    }

    function addLocationToggle() {
        const container = document.querySelector('.dashboard-quickaction-card .action-buttons');
        if (!container) return;
        
        const toggleBtn = document.createElement('button');
        toggleBtn.id = 'location-toggle';
        toggleBtn.className = 'btn btn-warning';
        toggleBtn.textContent = 'Start Location Sharing';
        toggleBtn.onclick = toggleLocationSharing;
        
        container.appendChild(toggleBtn);
    }

    function toggleLocationSharing() {
        if (isTracking) {
            stopLocationTracking();
        } else {
            startLocationTracking();
        }
    }

    function startLocationTracking() {
        if (!navigator.geolocation) {
            alert('Geolocation is not supported by your browser');
            return;
        }
        
        const toggleBtn = document.getElementById('location-toggle');
        if (toggleBtn) {
            toggleBtn.textContent = 'Stop Location Sharing';
            toggleBtn.className = 'btn btn-danger';
        }
        
        const options = {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        };
        
        locationWatchId = navigator.geolocation.watchPosition(
            handleLocationUpdate,
            handleLocationError,
            options
        );
        
        isTracking = true;
        console.log('Location tracking started');
    }

    function stopLocationTracking() {
        if (locationWatchId !== null) {
            navigator.geolocation.clearWatch(locationWatchId);
            locationWatchId = null;
        }
        
        const toggleBtn = document.getElementById('location-toggle');
        if (toggleBtn) {
            toggleBtn.textContent = 'Start Location Sharing';
            toggleBtn.className = 'btn btn-success';
        }
        
        isTracking = false;
        console.log('Location tracking stopped');
    }

    async function handleLocationUpdate(position) {
        const locationData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy,
            heading: position.coords.heading,
            speed: position.coords.speed
        };
        
        console.log('Location updated:', locationData);
        
        try {
            const response = await fetch('/booking/api/location/update/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(locationData)
            });
            
            if (!response.ok) {
                throw new Error('Failed to update location');
            }
            
            const data = await response.json();
            console.log('Location update response:', data);
            
            updateLocationStatus('success');
            
        } catch (error) {
            console.error('Error updating location:', error);
            updateLocationStatus('error');
        }
    }

    function handleLocationError(error) {
        console.error('Geolocation error:', error);
        
        let message = 'Unknown error';
        switch(error.code) {
            case error.PERMISSION_DENIED:
                message = 'Location permission denied. Please enable location access.';
                break;
            case error.POSITION_UNAVAILABLE:
                message = 'Location information unavailable.';
                break;
            case error.TIMEOUT:
                message = 'Location request timed out.';
                break;
        }
        
        updateLocationStatus('error', message);
    }

    function updateLocationStatus(status, message) {
        let statusDiv = document.getElementById('location-status');
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'location-status';
            statusDiv.style.cssText = `
                position: fixed;
                top: 70px;
                right: 20px;
                padding: 10px 15px;
                border-radius: 4px;
                color: white;
                font-size: 14px;
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            document.body.appendChild(statusDiv);
        }
        
        if (status === 'success') {
            statusDiv.style.backgroundColor = '#28a745';
            statusDiv.innerHTML = '<span style="width: 8px; height: 8px; background: white; border-radius: 50%; display: inline-block;"></span> Location Sharing Active';
        } else if (status === 'error') {
            statusDiv.style.backgroundColor = '#dc3545';
            statusDiv.innerHTML = '<span>âš </span> ' + (message || 'Location Error');
        }
        
        if (status === 'error') {
            setTimeout(() => {
                if (statusDiv.style.backgroundColor === 'rgb(220, 53, 69)') {
                    statusDiv.style.display = 'none';
                }
            }, 3000);
        } else {
            statusDiv.style.display = 'flex';
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    document.addEventListener('click', function(e) {
        if (e.target.type === 'submit' && e.target.closest('form[action*="accept_ride"]')) {
            setTimeout(() => {
                startLocationTracking();
            }, 1000);
        }
    });

    document.addEventListener('click', function(e) {
        if (e.target.type === 'submit' && 
            (e.target.closest('form[action*="complete_booking"]') || 
            e.target.closest('form[action*="cancel_accepted_booking"]'))) {
            stopLocationTracking();
        }
    });

    window.addEventListener('beforeunload', function() {
        if (isTracking) {
            localStorage.setItem('driverTracking', 'true');
        }
    });

    window.addEventListener('load', function() {
        if (localStorage.getItem('driverTracking') === 'true') {
            checkActiveBooking();
        }
    });
    </script>
</body>
</html>